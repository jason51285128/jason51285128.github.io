---
layout: post
title: 并发之event_pull
categories: linux
tags: [os, linux, kernel, concurrency, eventpoll] 
---

# 并发之event_pull

## select、poll

1.  遍历文件描述符表，将进程添加到每个描述符的等待队列中，挂起进程
1.  某个文件描述符就绪，中断处理程序，遍历文件描述符表，将进程从每个文件描述符的等待队列中
    移除，唤醒进程
1.  进程遍历文件描述符表，处理数据
1.  重复第一步

## epoll

select、poll缺陷：

1.  不能动态管理描述符，用表来管理描述符，每次调用都要将要监控的描述符重新添加到表

1.  通过遍历表来获得描述符上的事件，再讲结果返回给用户，用户再遍历表来处理

epoll 原理：

1.  通过红黑树来管理待监控的描述符，可以动态添加、删除、更新描述符，O(lgn)

1.  向每个描述符的等待队列注册ep_poll_callback回调函数，当描述符上的事件发生时，
    讲描述符添加到epoll的rdllist（双向链表），epool_wait每次取rdllist中的描述符

1.  用户直接处理就绪的描述符

**对事件的监控上，改原来的轮询（同步非阻塞）方式为异步通知回调（异步阻塞）方式，从而提高文件描述符
监控的数量和效率。**

### epoll触发方式

#### 水平触发

1.  对于读操作

    只要缓冲内容不为空，LT模式返回读就绪。

1.  对于写操作

    只要缓冲区还不满，LT模式会返回写就绪。

#### 边缘触发

1. 对于读操作

    1.  当缓冲区由不可读变为可读的时候，即缓冲区由空变为不空的时候。

    1.  当有新数据到达时，即缓冲区中的待读数据变多的时候。

    1.  当缓冲区有数据可读，且应用进程对相应的描述符进行EPOLL_CTL_MOD 修改EPOLLIN事件时。

1. 对于写操作

    1.  当缓冲区由不可写变为可写时。

    1.  当有旧数据被发送走，即缓冲区中的内容变少的时候。

    1.  当缓冲区有空间可写，且应用进程对相应的描述符进行EPOLL_CTL_MOD 修改EPOLLOUT事件时。

### epoll API

1.  epoll_create创建epoll实例，返还epoll文件描述符

1.  epoll_ctl注册要监视的文件描述

1.  epoll_wait阻塞当前先线程，等待事件发生






